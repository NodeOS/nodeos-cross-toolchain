#!/usr/bin/env node

const join = require('path').join

const async   = require('async')
const fs      = require('fs-extra')
const manager = require('download-manager')
const os      = require('os')
const path    = require('path')


const DEPS='deps'
const PATCHES='patches'

const options = {path: DEPS}


// Source versions

const BINUTILS_VERSION = "2.27"
const GCC_VERSION      = "5.3.0"
const LINUX_VERSION    = "4.8.5"
const MUSL_VERSION     = "1.1.15"


// Source URLs

const BINUTILS_URL = "http://ftpmirror.gnu.org/binutils/binutils-"+BINUTILS_VERSION+".tar.gz"
const GCC_URL      = "http://ftpmirror.gnu.org/gcc/gcc-"+GCC_VERSION+"/gcc-"+GCC_VERSION+".tar.gz"
const LINUX_URL    = "https://www.kernel.org/pub/linux/kernel/v4.x/linux-"+LINUX_VERSION+".tar.gz"
const MUSL_URL     = "http://www.musl-libc.org/releases/musl-"+MUSL_VERSION+".tar.gz"


// Checksums

const LINUX_SHA256 = 'b8dd5365c9f4319d41781f65f27b116ae7981d791bbad46491617fee0f87f8cc'


// Patch GCC to work with musl
const GCC_PATCH_URL = 'https://raw.githubusercontent.com/GregorR/musl-cross/master/patches/gcc-'+GCC_VERSION+'-musl.diff'

// Patch Linux to use musl headers on OS X
const LINUX_DARWIN_PATCH_PATH = PATCHES+'/linux-darwin.diff'

//
// gcc prerequisites
//

function download_prerequisites(callback)
{
  // Download source code of mpfr, gmp & mpc
//    contrib/download_prerequisites

  var name = this.name

  // Source versions

  const MPFR_VERSION = "3.1.4"
  const GMP_VERSION  = "6.1.1"
  const MPC_VERSION  = "1.0.2"


  // Source URLs

  const MPFR_URL = "http://www.mpfr.org/mpfr-"+MPFR_VERSION+"/mpfr-"+MPFR_VERSION+".tar.gz"
  const GMP_URL  = "https://gmplib.org/download/gmp/gmp-"+GMP_VERSION+".tar.bz2"
  const MPC_URL  = "http://ftpmirror.gnu.org/mpc/mpc-"+MPC_VERSION+".tar.gz"


  var downloads =
  [
    {
      name: join(name, 'mpfr'),
      url: MPFR_URL
    },
    {
      name: join(name, 'gmp'),
      url: GMP_URL
    },
    {
      name: join(name, 'mpc'),
      url: MPC_URL
    }
  ]


  manager(downloads, options, callback)
}

//
// binutils, gcc, Linux & musl
//

var downloads =
[
  {
    name: 'binutils',
    url: BINUTILS_URL
  },
  {
    name: 'gcc',
    url: GCC_URL,
    patch: GCC_PATCH_URL,
    strip: 1,
    action: download_prerequisites
  },
  {
    name: 'linux',
    url: LINUX_URL,
    sha256: LINUX_SHA256
  },
  {
    name: 'musl',
    url: MUSL_URL
  }
]

// Copy musl headers for compilation on OS X
function copy_headers(callback) {
  const MUSL_INCLUDE_PATH = DEPS+'/musl/include'
  const DARWIN_MUSL_PATH = DEPS+'/darwin-musl'


  async.each(require('../resources/darwin-headers.json'),
  function(file, callback)
  {
    fs.copy(MUSL_INCLUDE_PATH+'/'+file, DARWIN_MUSL_PATH+'/'+file, callback)
  },
  callback)
}

if (process.platform === 'darwin') {
  downloads[2].patch = LINUX_DARWIN_PATCH_PATH
  downloads[3].action = copy_headers
}

manager(downloads, options, function(error)
{
  if(error)
  {
    console.trace(error)
    process.exit(1)
  }
})
